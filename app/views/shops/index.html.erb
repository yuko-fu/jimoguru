<p id="notice"><%= notice %></p>

<h1>お店検索</h1>

<table>
  <thead>

    <tr>
      <th>店名</th>
      <th>都道府県</th>
      <th>住所</th>
      <th>カテゴリー</th>
      <th colspan="3"></th>
    </tr>
  </thead>
  
  <tbody>
  
  <%= form_tag shops_path, method: :get do %>
    <%= select_tag :prefecture, options_for_select(Shop.pluck(:prefecture).uniq), prompt: '都道府県で絞る' %>
    <%= select_tag :category_id, options_for_select(@categories.pluck(:name, :id)), prompt: 'カテゴリーで絞る' %>
    <%= submit_tag '検索' %>
  <% end %>

  <%= link_to 'お店新規登録', new_shop_path %>

    <% @shops.each do |shop| %>
      <tr>
        <td><%= shop.name %></td>
        <td><%= shop.prefecture %></td>
        <td><%= shop.address %></td>
        <td><%= shop.category.name %></td>
        <td><%= link_to 'Show', shop %></td>
        <td><%= link_to 'Edit', edit_shop_path(shop) %></td>
        <td><%= link_to 'Destroy', shop, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      
      </tr>
    <% end %>
    
 <style>
    #map {
      height: 500px;
      width: 100%;
    }
  </style>

  <div id="map"></div>
  <script>
    var map;
    var markers = [];
    var infoWindows = [];
    var geocoder;
    
    // データベースから取得したマーカー情報（例：仮のデータ）
    var markerData = <%= raw @shops.to_json %>;

    function initMap() {
    geocoder = new google.maps.Geocoder();

    map = new google.maps.Map(document.getElementById('map'), {
      zoom: 7,
      center: { lat: 35.4550426, lng: 139.6312741 }
    });

    displayMarkers();
  }

  function displayMarkers() {
    var bounds = new google.maps.LatLngBounds(); // 新しい LatLngBounds オブジェクトを作成

    markerData.forEach(shop => {
      var markerLatLng = { lat: shop.latitude, lng: shop.longitude };
      var marker = new google.maps.Marker({
        position: markerLatLng,
        map: map,
        title: shop.name
      });

      bounds.extend(marker.getPosition()); // LatLngBounds オブジェクトに座標を追加
      markers.push(marker);

      var infoWindow = new google.maps.InfoWindow({
        content: `<a href='/shops/${shop.id}' class='custom-link'>${shop.name}</a>`
      });

      infoWindows.push(infoWindow);

      marker.addListener('click', function () {
        closeInfoWindows();
        infoWindow.open(map, marker);
      });
    });

    map.fitBounds(bounds); // LatLngBounds オブジェクトを使用して地図の中心とズームを調整
  }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAP_API_KEY'] %>&libraries=places&callback=initMap" async defer></script> 
  </tbody>
</table>

<br>

<%= link_to 'お店新規登録', new_shop_path %>
